<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ULP P2P Server - ULP v2.0 Browser</title>

	<!-- PWA Meta Tags -->
	<meta name="description" content="Browser-based ULP v2.0 record verification with WebAuthn">
	<meta name="theme-color" content="#1a1a1a">
	<link rel="manifest" href="/manifest.json">
	<link rel="icon" type="image/png" href="/icon-192.png">
	<link rel="apple-touch-icon" href="/icon-192.png">

	<style>
		:root {
			--bg: #ffffff;
			--text: #1a1a1a;
			--border: #cccccc;
			--accent: #0066cc;
			--success: #28a745;
			--error: #dc3545;
			--bg-secondary: #f5f5f5;
		}

		@media (prefers-color-scheme: dark) {
			:root {
				--bg: #1a1a1a;
				--text: #ffffff;
				--border: #444444;
				--bg-secondary: #2a2a2a;
			}
		}

		* { box-sizing: border-box; }

		body {
			font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Consolas', monospace;
			max-width: 1200px;
			margin: 0 auto;
			padding: 20px;
			background: var(--bg);
			color: var(--text);
			line-height: 1.6;
		}

		h1 {
			border-bottom: 2px solid var(--accent);
			padding-bottom: 10px;
		}

		.card {
			border: 1px solid var(--border);
			padding: 20px;
			margin: 20px 0;
			border-radius: 8px;
			background: var(--bg-secondary);
		}

		.qr-code {
			text-align: center;
			padding: 20px;
		}

		.qr-code img {
			max-width: 256px;
			border: 2px solid var(--border);
		}

		.record {
			border: 1px solid var(--border);
			padding: 15px;
			margin: 10px 0;
			border-radius: 4px;
		}

		.rid {
			color: var(--accent);
			font-weight: bold;
			word-break: break-all;
		}

		.policy {
			background: var(--bg);
			padding: 10px;
			margin: 10px 0;
			border-left: 3px solid var(--accent);
		}

		button {
			padding: 10px 20px;
			font-size: 16px;
			cursor: pointer;
			border: 1px solid var(--border);
			background: var(--accent);
			color: white;
			border-radius: 4px;
			font-family: inherit;
		}

		button:hover {
			opacity: 0.9;
		}

		button:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}

		.success { color: var(--success); }
		.error { color: var(--error); }

		.auth-section {
			background: var(--bg-secondary);
			padding: 20px;
			border-radius: 8px;
			margin: 20px 0;
		}

		.hidden { display: none; }

		input {
			padding: 10px;
			font-size: 16px;
			border: 1px solid var(--border);
			background: var(--bg);
			color: var(--text);
			border-radius: 4px;
			font-family: inherit;
			width: 100%;
			max-width: 300px;
		}

		.install-prompt {
			background: var(--accent);
			color: white;
			padding: 15px;
			border-radius: 8px;
			margin: 20px 0;
			text-align: center;
		}

		.status-badge {
			display: inline-block;
			padding: 4px 8px;
			border-radius: 4px;
			font-size: 12px;
			font-weight: bold;
		}

		.status-online {
			background: var(--success);
			color: white;
		}

		.status-offline {
			background: var(--error);
			color: white;
		}
	</style>
</head>
<body>
	<h1>ULP P2P Server</h1>
	<p>ULP v2.0 Browser with WebAuthn & PWA Support</p>

	<!-- Install Prompt -->
	<div id="install-prompt" class="install-prompt hidden">
		<p>üì± Install ULP P2P Server as an app</p>
		<button onclick="installPWA()">Install</button>
		<button onclick="dismissInstall()">Maybe Later</button>
	</div>

	<!-- Online/Offline Status -->
	<div>
		<span id="online-status" class="status-badge status-online">üü¢ Online</span>
	</div>

	<!-- WebAuthn Section -->
	<div class="auth-section">
		<h2>üîê WebAuthn Authentication</h2>
		<div id="auth-logged-out">
			<p>Secure, passwordless authentication using hardware keys, Touch ID, or Face ID.</p>
			<input type="text" id="username" placeholder="Username" value="user@example.com" />
			<div style="margin-top: 10px;">
				<button onclick="registerWebAuthn()">Register New Device</button>
				<button onclick="loginWebAuthn()">Login</button>
			</div>
			<p id="auth-status"></p>
		</div>
		<div id="auth-logged-in" class="hidden">
			<p class="success">‚úì Authenticated as <span id="auth-user"></span></p>
			<button onclick="logout()">Logout</button>
		</div>
	</div>

	<!-- Connection Info -->
	<div class="card">
		<h2>üì° Peer Connection</h2>
		<div class="qr-code">
			<img id="qr" src="/qr" alt="Connection QR Code" />
			<p id="peer-id" style="word-break: break-all;"></p>
		</div>
	</div>

	<!-- Records List -->
	<div class="card">
		<h2>üìö ULP Records</h2>
		<div id="records"></div>
	</div>

	<script>
		// PWA Installation
		let deferredPrompt;

		window.addEventListener('beforeinstallprompt', (e) => {
			e.preventDefault();
			deferredPrompt = e;
			document.getElementById('install-prompt').classList.remove('hidden');
		});

		async function installPWA() {
			if (!deferredPrompt) return;

			deferredPrompt.prompt();
			const { outcome } = await deferredPrompt.userChoice;

			if (outcome === 'accepted') {
				console.log('PWA installed');
			}

			deferredPrompt = null;
			document.getElementById('install-prompt').classList.add('hidden');
		}

		function dismissInstall() {
			document.getElementById('install-prompt').classList.add('hidden');
		}

		// Service Worker Registration
		if ('serviceWorker' in navigator) {
			navigator.serviceWorker.register('/sw.js').then(reg => {
				console.log('Service Worker registered:', reg);
			});
		}

		// Online/Offline Status
		function updateOnlineStatus() {
			const status = document.getElementById('online-status');
			if (navigator.onLine) {
				status.textContent = 'üü¢ Online';
				status.className = 'status-badge status-online';
			} else {
				status.textContent = 'üî¥ Offline';
				status.className = 'status-badge status-offline';
			}
		}

		window.addEventListener('online', updateOnlineStatus);
		window.addEventListener('offline', updateOnlineStatus);
		updateOnlineStatus();

		// WebAuthn Implementation
		async function registerWebAuthn() {
			const username = document.getElementById('username').value;
			const status = document.getElementById('auth-status');

			if (!username) {
				status.innerHTML = '<span class="error">Please enter a username</span>';
				return;
			}

			try {
				status.textContent = 'Starting registration...';

				// Begin registration
				const beginResp = await fetch('/api/webauthn/register/begin', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						username: username,
						displayName: username
					})
				});

				if (!beginResp.ok) {
					throw new Error(await beginResp.text());
				}

				const options = await beginResp.json();

				// Convert base64 strings to buffers
				options.publicKey.challenge = base64ToBuffer(options.publicKey.challenge);
				options.publicKey.user.id = base64ToBuffer(options.publicKey.user.id);

				if (options.publicKey.excludeCredentials) {
					options.publicKey.excludeCredentials = options.publicKey.excludeCredentials.map(c => ({
						...c,
						id: base64ToBuffer(c.id)
					}));
				}

				// Create credential
				status.textContent = 'Touch your security key...';
				const credential = await navigator.credentials.create(options);

				// Finish registration
				const finishResp = await fetch('/api/webauthn/register/finish', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						username: username,
						...credentialToJSON(credential)
					})
				});

				if (!finishResp.ok) {
					throw new Error(await finishResp.text());
				}

				status.innerHTML = '<span class="success">‚úì Registration successful! You can now login.</span>';
			} catch (err) {
				status.innerHTML = '<span class="error">‚úó Registration failed: ' + err.message + '</span>';
				console.error(err);
			}
		}

		async function loginWebAuthn() {
			const username = document.getElementById('username').value;
			const status = document.getElementById('auth-status');

			if (!username) {
				status.innerHTML = '<span class="error">Please enter a username</span>';
				return;
			}

			try {
				status.textContent = 'Starting login...';

				// Begin login
				const beginResp = await fetch('/api/webauthn/login/begin', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ username: username })
				});

				if (!beginResp.ok) {
					throw new Error(await beginResp.text());
				}

				const options = await beginResp.json();

				// Convert base64 strings to buffers
				options.publicKey.challenge = base64ToBuffer(options.publicKey.challenge);

				if (options.publicKey.allowCredentials) {
					options.publicKey.allowCredentials = options.publicKey.allowCredentials.map(c => ({
						...c,
						id: base64ToBuffer(c.id)
					}));
				}

				// Get assertion
				status.textContent = 'Touch your security key...';
				const assertion = await navigator.credentials.get(options);

				// Finish login
				const finishResp = await fetch('/api/webauthn/login/finish', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						username: username,
						...credentialToJSON(assertion)
					})
				});

				if (!finishResp.ok) {
					throw new Error(await finishResp.text());
				}

				const result = await finishResp.json();

				// Update UI
				document.getElementById('auth-logged-out').classList.add('hidden');
				document.getElementById('auth-logged-in').classList.remove('hidden');
				document.getElementById('auth-user').textContent = username;

				status.innerHTML = '<span class="success">‚úì Login successful!</span>';
			} catch (err) {
				status.innerHTML = '<span class="error">‚úó Login failed: ' + err.message + '</span>';
				console.error(err);
			}
		}

		function logout() {
			document.getElementById('auth-logged-in').classList.add('hidden');
			document.getElementById('auth-logged-out').classList.remove('hidden');
			document.getElementById('auth-status').innerHTML = '<span class="success">Logged out</span>';
		}

		// Base64 helpers
		function base64ToBuffer(base64) {
			const binary = atob(base64.replace(/-/g, '+').replace(/_/g, '/'));
			const bytes = new Uint8Array(binary.length);
			for (let i = 0; i < binary.length; i++) {
				bytes[i] = binary.charCodeAt(i);
			}
			return bytes.buffer;
		}

		function bufferToBase64(buffer) {
			const bytes = new Uint8Array(buffer);
			let binary = '';
			for (let i = 0; i < bytes.length; i++) {
				binary += String.fromCharCode(bytes[i]);
			}
			return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
		}

		function credentialToJSON(credential) {
			const response = credential.response;
			return {
				id: credential.id,
				rawId: bufferToBase64(credential.rawId),
				type: credential.type,
				response: {
					clientDataJSON: bufferToBase64(response.clientDataJSON),
					attestationObject: response.attestationObject ? bufferToBase64(response.attestationObject) : undefined,
					authenticatorData: response.authenticatorData ? bufferToBase64(response.authenticatorData) : undefined,
					signature: response.signature ? bufferToBase64(response.signature) : undefined,
					userHandle: response.userHandle ? bufferToBase64(response.userHandle) : undefined
				}
			};
		}

		// Load connection info
		fetch('/api/connection')
			.then(r => r.json())
			.then(data => {
				document.getElementById('peer-id').textContent = 'Peer ID: ' + data.peerId;
			});

		// Load records
		fetch('/api/records')
			.then(r => r.json())
			.then(records => {
				const container = document.getElementById('records');

				if (records.length === 0) {
					container.innerHTML = '<p>No records found. Generate ULP traces to see them here.</p>';
					return;
				}

				records.forEach(record => {
					const div = document.createElement('div');
					div.className = 'record';
					div.innerHTML = `
						<div class="rid">ulp://${record.rid}</div>
						<div>Size: ${record.size} bytes</div>
						${record.policy ? `
						<div class="policy">
							<strong>Policy Metadata:</strong><br/>
							E8L: ${record.policy.e8l.substring(0, 16)}...<br/>
							E8R: ${record.policy.e8r.substring(0, 16)}...<br/>
							Chirality: ${record.policy.chirality}<br/>
							Geometry: ${record.policy.projective} / ${record.policy.causality} / ${record.policy.incidence}<br/>
							Replica Slots: [${record.policy.slots.join(', ')}]
						</div>
						` : ''}
						<button onclick="verifyRecord('${record.rid}')">Verify Record</button>
					`;
					container.appendChild(div);
				});
			})
			.catch(err => {
				document.getElementById('records').innerHTML =
					'<p class="error">Error loading records: ' + err.message + '</p>';
			});

		// Verify record integrity
		async function verifyRecord(rid) {
			try {
				const resp = await fetch('/api/record/' + rid);
				if (!resp.ok) throw new Error('Record not found');

				const bytes = await resp.arrayBuffer();

				// Compute SHA-256
				const hash = await crypto.subtle.digest('SHA-256', bytes);
				const hashHex = Array.from(new Uint8Array(hash))
					.map(b => b.toString(16).padStart(2, '0'))
					.join('');

				if (hashHex === rid) {
					alert('‚úì Record verified!\n\nSHA-256 hash matches RID.\nThis trace is cryptographically proven to be unmodified.');
				} else {
					alert('‚úó Verification failed!\n\nHash mismatch:\nExpected: ' + rid + '\nGot: ' + hashHex);
				}
			} catch (err) {
				alert('‚úó Verification error: ' + err.message);
			}
		}

		// Check WebAuthn availability
		if (!window.PublicKeyCredential) {
			document.querySelector('.auth-section').innerHTML =
				'<h2>üîê WebAuthn Not Available</h2><p>Your browser doesn\'t support WebAuthn. Try Chrome, Firefox, Safari, or Edge.</p>';
		}
	</script>
</body>
</html>
