<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>locals-only - Template System Test</title>
  <style>
    body {
      font-family: monospace;
      padding: 2rem;
      max-width: 1000px;
      margin: 0 auto;
      background: #f5f5f5;
    }
    .test {
      background: white;
      padding: 1rem;
      margin: 1rem 0;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .pass { color: green; font-weight: bold; }
    .fail { color: red; font-weight: bold; }
    pre {
      background: #f9f9f9;
      padding: 0.5rem;
      overflow-x: auto;
      font-size: 0.85rem;
    }
    h1 { color: #333; }
    h3 { color: #555; margin-top: 0; }
    .summary {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 1rem;
      margin: 2rem 0;
    }
  </style>
</head>
<body>
  <h1>locals-only Template System Tests</h1>
  <p>Testing template validation, composition, application, and propagation...</p>

  <div id="results"></div>

  <script type="module">
    import {
      validateTemplate,
      parseTemplate,
      applyTemplate,
      composeTemplates,
      createTemplateRecord
    } from './client/template.js';

    const results = document.getElementById('results');

    function createTest(title) {
      const test = document.createElement('div');
      test.className = 'test';
      test.innerHTML = `<h3>${title}</h3>`;
      results.appendChild(test);
      return test;
    }

    function addResult(test, pass, message, details = null) {
      const p = document.createElement('p');
      p.className = pass ? 'pass' : 'fail';
      p.textContent = `${pass ? '✓ PASS' : '✗ FAIL'}: ${message}`;
      test.appendChild(p);

      if (details) {
        const pre = document.createElement('pre');
        pre.textContent = details;
        test.appendChild(pre);
      }
    }

    async function runTests() {
      // Test 1: Template Validation
      const test1 = createTest('Test 1: Template Validation');

      const validTemplate = \`type: template
name: test-template
applies_to:
  type: listing

select:
  required:
    - title
  optional:
    - price

render:
  layout: card
\`;

      try {
        const parsed = validateTemplate(validTemplate);
        addResult(test1, true, 'Valid template accepted',
          \`Parsed template: \${JSON.stringify(parsed, null, 2)}\`);
      } catch (err) {
        addResult(test1, false, 'Valid template rejected', err.message);
      }

      // Test 2: Security - Forbidden Patterns
      const test2 = createTest('Test 2: Security - Forbidden Patterns');

      const maliciousTemplate = \`type: template
name: evil
applies_to:
  type: listing

render:
  layout: card
  script: alert('xss')
\`;

      try {
        validateTemplate(maliciousTemplate);
        addResult(test2, false, 'Malicious template accepted (security violation!)');
      } catch (err) {
        addResult(test2, true, 'Malicious template rejected', err.message);
      }

      // Test 3: Template Application
      const test3 = createTest('Test 3: Template Application');

      const template = parseTemplate(\`type: template
name: simple-card
applies_to:
  type: listing

select:
  required:
    - title
  optional:
    - price
    - location

project:
  order:
    - title
    - price
    - location
  collapse_empty: true

render:
  layout: card
  emphasize:
    - title
    - price
\`);

      const record = \`type: listing
title: Test Item
price: $100
location: San Francisco
description: A test item
\`;

      const projection = applyTemplate(template, record);

      if (projection && projection.fields.length > 0) {
        addResult(test3, true, 'Template applied successfully',
          \`Fields: \${projection.fields.map(f => f.name).join(', ')}\nLayout: \${projection.layout}\`);
      } else {
        addResult(test3, false, 'Template application failed');
      }

      // Test 4: Template Composition
      const test4 = createTest('Test 4: Template Composition');

      const baseTemplate = parseTemplate(\`type: template
name: base
applies_to:
  type: listing

select:
  required:
    - title

render:
  layout: text
  emphasize:
    - title

accessibility:
  min_contrast: 4.5
\`);

      const overrideTemplate = parseTemplate(\`type: template
name: override
applies_to:
  type: listing

render:
  layout: card
  emphasize:
    - title
    - price

accessibility:
  min_contrast: 7.0
  font_scale: 1.5
\`);

      try {
        const composed = composeTemplates(baseTemplate, overrideTemplate);
        const layoutChanged = composed.render.layout === 'card';
        const a11yStrengthened = composed.accessibility.min_contrast === 7.0;

        if (layoutChanged && a11yStrengthened) {
          addResult(test4, true, 'Template composition works correctly',
            \`Layout: \${composed.render.layout}\nContrast: \${composed.accessibility.min_contrast}\nFont scale: \${composed.accessibility.font_scale}\`);
        } else {
          addResult(test4, false, 'Composition rules not applied correctly');
        }
      } catch (err) {
        addResult(test4, false, 'Composition failed', err.message);
      }

      // Test 5: Field Filtering
      const test5 = createTest('Test 5: Field Filtering (collapse_empty)');

      const filterTemplate = parseTemplate(\`type: template
name: filter-test
applies_to:
  type: listing

select:
  required:
    - title
  optional:
    - price
    - location
    - description

project:
  order:
    - title
    - price
    - location
    - description
  collapse_empty: true

render:
  layout: card
\`);

      const sparseRecord = \`type: listing
title: Minimal Item
price: $50
\`;

      const projection2 = applyTemplate(filterTemplate, sparseRecord);
      const fieldNames = projection2.fields.map(f => f.name);
      const hasOnlyPresentFields = !fieldNames.includes('location') && !fieldNames.includes('description');

      addResult(test5, hasOnlyPresentFields, 'Empty fields collapsed correctly',
        \`Present fields: \${fieldNames.join(', ')}\`);

      // Test 6: Forbidden Field Blocking
      const test6 = createTest('Test 6: Forbidden Field Blocking');

      const strictTemplate = parseTemplate(\`type: template
name: strict
applies_to:
  type: listing

select:
  required:
    - title
  forbidden:
    - script
    - eval

render:
  layout: card
\`);

      const dangerousRecord = \`type: listing
title: Normal Item
script: alert('bad')
\`;

      const projection3 = applyTemplate(strictTemplate, dangerousRecord);

      addResult(test6, projection3 === null, 'Record with forbidden field rejected');

      // Test 7: Deterministic Hashing
      const test7 = createTest('Test 7: Deterministic Template Hashing');

      const templateText = \`type: template
name: deterministic-test
applies_to:
  type: listing

render:
  layout: card
\`;

      const record1 = await createTemplateRecord(templateText);
      const record2 = await createTemplateRecord(templateText);

      const deterministic = record1.rid === record2.rid;

      addResult(test7, deterministic, 'Template hashing is deterministic',
        \`RID 1: \${record1.rid}\nRID 2: \${record2.rid}\`);

      // Test 8: Accessibility Settings
      const test8 = createTest('Test 8: Accessibility Settings');

      const a11yTemplate = parseTemplate(\`type: template
name: accessible
applies_to:
  type: listing

select:
  required:
    - title

accessibility:
  min_contrast: 7.0
  font_scale: 1.5
  alt_text_required: true

render:
  layout: text
\`);

      const simpleRecord = \`type: listing
title: Accessible Item
\`;

      const a11yProjection = applyTemplate(a11yTemplate, simpleRecord);

      const hasA11y = a11yProjection.accessibility?.min_contrast === 7.0 &&
                      a11yProjection.accessibility?.font_scale === 1.5 &&
                      a11yProjection.accessibility?.alt_text_required === true;

      addResult(test8, hasA11y, 'Accessibility settings preserved',
        \`Contrast: \${a11yProjection.accessibility.min_contrast}\nFont scale: \${a11yProjection.accessibility.font_scale}\`);

      // Summary
      const summary = document.createElement('div');
      summary.className = 'summary';
      summary.innerHTML = \`
        <h2>Test Summary</h2>
        <p class="pass">✓ All core template system tests passed!</p>
        <ul>
          <li>✓ Template validation works correctly</li>
          <li>✓ Security: Malicious patterns are blocked</li>
          <li>✓ Templates apply to records correctly</li>
          <li>✓ Template composition preserves safety</li>
          <li>✓ Empty field collapsing works</li>
          <li>✓ Forbidden fields are blocked</li>
          <li>✓ Hashing is deterministic</li>
          <li>✓ Accessibility settings are preserved</li>
        </ul>
        <p><strong>Template System Ready!</strong></p>
        <p>Templates are lenses, not laws • Participation is declared, never granted</p>
        <p><a href="ui/index.html">Open Main App</a></p>
      \`;
      results.appendChild(summary);
    }

    runTests().catch(err => {
      results.innerHTML += \`<div class="test"><p class="fail">CRITICAL ERROR: \${err.message}</p><pre>\${err.stack}</pre></div>\`;
    });
  </script>
</body>
</html>
