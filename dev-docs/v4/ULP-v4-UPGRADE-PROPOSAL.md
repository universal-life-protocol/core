# ULP v4 Upgrade Proposal (v1.1 -> v3.0)

## Purpose

Define a v4 upgrade path that preserves the v1.1/v2.0/v3.0 invariants while
formalizing "intent -> trace -> projection" as a first-class execution layer
for decentralized, UI-driven domains (e.g., Blackboard).

This proposal does not change existing cores; it adds a compatibility and
mapping layer that can be adopted incrementally.

## Guiding principles (carried forward)

- Trace is ground truth and append-only.
- World dotfiles remain non-executable.
- Projections are pure and deterministic.
- Determinism: identical inputs produce byte-identical traces.
- No global ordering assumptions.

## What v4 adds

### 1) Standard Intent Envelope

Introduce a stable, versioned envelope for "intent traces" that can be
generated by UIs and consumed by projections:

```json
{
  "v": 4,
  "id": "ulp:v4:<hash>",
  "ts": 0,
  "kind": "intent",
  "template": "blackboard.node.v1",
  "author": "optional-key-or-null",
  "payload": {
    "intentVersion": 1,
    "intent": {
      "type": "NODE_CREATE",
      "nodeId": "..."
    }
  },
  "refs": ["ulp:ref:node:..."],
  "sig": "optional"
}
```

Notes:
- `id` is content-addressed (hash of canonicalized trace without `id`).
- `template` selects a schema for the intent payload.
- `refs` is a stable linkage mechanism for projections.

### 2) Canonical JSON Serialization (for hashing)

Define a canonical JSON representation used by v4 hashing:

- UTF-8, no BOM.
- Object keys sorted lexicographically (byte order).
- No insignificant whitespace.
- Numbers normalized (no leading `+`, no trailing zeros).
- Strings escaped per JSON standard.

This mirrors v3 CPNF determinism in a JSON world.

### 3) Deterministic Projection Rules

Projection engines must:

- Be pure functions of ordered trace sets.
- Be idempotent under duplicate delivery.
- Resolve conflicts deterministically (default: LWW by `(ts, id)`).
- Surface conflicts as UI metadata rather than mutation.

### 4) Intent Taxonomy (first-class)

Adopt a domain-specific intent taxonomy (as in `dev-docs/v4/Blackboard/`):

- Geometry: MOVE, RESIZE
- Content: EDIT, PATCH
- Structure: CREATE, DELETE, GROUP
- Relationships: EDGE_CREATE, EDGE_DELETE
- Meta: LOCK, VISIBILITY, CONFLICT_MARK

This taxonomy is a spec boundary, not a UI API.

## Compatibility strategy (v1.1 -> v3.0)

### v1.1

Add a projection adapter that reads v1.1 traces and emits v4 intents as
derived events (local-only projection; no mutation of original traces).

- Treat v1.1 EXEC/CLAUSE entries as "intent-derived" projections.
- Preserve v1.1 sealing; no new trace types are written.

### v2.0

Map v2.0 trace `POLICY/GEOMETRY/REPLICA` metadata into v4 `refs` and
attribution fields (no schema changes to v2.0).

Add an adapter that can emit v4 "intent traces" as new, opt-in outputs.

### v3.0

Reuse v3 dotfile identity and determinism constraints for v4 traces:

- The "world" remains non-executable authority.
- v4 intent traces can be generated by apps, but the v3 engine remains the
  canonical executor for core traces.

Provide a v3 projection that can consume v4 traces as input views.

## Upgrade phases

### Phase 0: Documentation and schema registry

- Add schema files for v4 intent templates.
- Specify canonical JSON hashing for v4 trace ids.
- Document required projection behavior.

### Phase 1: Adapter-only

- Build adapters that map v1.1/v2.0/v3.0 traces to v4 projection inputs.
- No changes to execution engines.
- Use adapters in `apps/` and dev tools.

### Phase 2: Optional v4 intent emission

- UI apps emit v4 intent traces directly.
- Traces remain append-only and compatible with v3 determinism rules.

### Phase 3: Native v4 toolchain (optional)

- Add `bin/intent_hash.sh` and `bin/intent_validate.sh` in v3 core.
- Provide conformance tests for intent determinism.

## Risks and mitigations

- Risk: JSON canonicalization divergence.
  - Mitigation: single canonicalization implementation in `bin/`.
- Risk: intent schema drift.
  - Mitigation: versioned templates and explicit `intentVersion`.
- Risk: cross-version confusion.
  - Mitigation: adapters keep old traces read-only; v4 is additive.

## Open decisions

1) Canonical JSON rules: adopt JCS or define a minimal ULP-specific variant.
2) ID strategy: UUIDv7 vs content-hash only (proposal prefers content-hash).
3) Conflict policy: LWW default vs CRDT-friendly variants per template.

## Concrete next steps

1) Create v4 template registry in `dev-docs/v4/templates/`.
2) Add a "blackboard.node.v1" schema and validator.
3) Write adapter spec: `dev-docs/v4/ULP-v3-to-v4-adapter.md`.
4) Add a conformance note to v3 tests: idempotent replay of intent traces.
